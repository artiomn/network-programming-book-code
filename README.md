TODO:

- Исправить пути и названия образов на скриншотах.


# Repository with a code for the "Network Programming in the High-level Languages" book

[![Build C++ code for Linux](https://github.com/artiomn/network-programming-book-code/actions/workflows/cpp-linux-build.yml/badge.svg)](https://github.com/artiomn/network-programming-book-code/actions/workflows/cpp-linux-build.yml)
[![Build and push Docker images](https://github.com/artiomn/network-programming-book-code/actions/workflows/docker-images-build.yml/badge.svg)](https://github.com/artiomn/network-programming-book-code/actions/workflows/docker-images-build.yml)

Код для книги "Сетевое программирование на языках высокого уровня".

## Оглавление

- [Начало работы](#начало-работы)
- [FAQ](#faq)
  * [Надо ли обновляться и как?](#надо-ли-обновляться-и-как)
  * [Как собрать примеры?](#как-собрать-примеры)
  * [Сборка не проходит, вообще не собирается ничего.](#сборка-не-проходит-вообще-не-собирается-ничего)
  * [Почему используется Linux?](#почему-используется-linux)
  * [Могу ли я собрать код на Windows?](#могу-ли-я-собрать-код-на-windows)
  * [А есть что-то про CMake?](#а-есть-что-то-про-cmake)
  * [Docker - что это?](#docker---что-это)
    - [Как использовать Docker?](#как-использовать-docker)
    - [У меня сборка только под суперпользователем (root) запускается, почему?](#у-меня-сборка-только-под-суперпользователем-root-запускается-почему)
    - [Могу ли я собирать в IDE?](#могу-ли-я-собирать-в-ide)
    - [Не могу подключиться к Docker либо IDE его не видит, что делать?](#не-могу-подключиться-к-docker-либо-ide-его-не-видит-что-делать)
    - [В образе чего-то не хватает.](#в-образе-чего-то-не-хватает)
    - [Работая в Docker я не могу испортить систему?](#работая-в-docker-я-не-могу-испортить-систему)
  * [Как запустить собранное?](#как-запустить-собранное)
  * [Как запустить консоль?](#как-запустить-консоль)
  * [Где взять Netcat под Windows?](#где-взять-netcat-под-windows)
  * [Всё делаю правильно, но что-то не подключается.](#всё-делаю-правильно-но-что-то-не-подключается)
  * [Я нашёл ошибку в коде, могу ли я её исправить?](#я-нашёл-ошибку-в-коде-могу-ли-я-её-исправить)


## Начало работы

Чтобы начать работать:

- Если [Docker](https://www.docker.com/) не установлен в системе, [установите его](#как-использовать-docker).
- Если [Git](https://git-scm.com/) не установлен в системе, [установите его](https://git-scm.com/book/ru/v2/Введение-Установка-Git).
- Склонируйте репозиторий: `git clone https://github.com/artiomn/cpp-network-tasks.git`.  
  **Внимание: склонируйте репозиторий в каталог, содержащий только латинские символы в пути!**
- Зайдите в каталог `cpp-network-tasks`.
- Запустите скрипт `./build_dockerized.sh`

Если это первый запуск, пройдёт значительное время перед тем, как вы получите результат.  
Возможно, что вам потребуется [установить Docker](#docker---что-это).

Для запуска IDE QtCreator выполните из каталога `cpp-network-tasks` следующую команду: `./run -q`.  
Будет запущена IDE, в которой необходимо открыть, как проект, файл `CMakeLists.txt` в каталоге `/home/developer/src` или `/usr/src/gb/src` (первый каталог - ссылка).


## FAQ

### Надо ли обновляться и как?

Иногда - надо. В код или образ могут вноситься изменения.
Если вы работаете с Git репозиторием, код обновляется следующим образом:

```
git pull 
```

Docker образы могут быть обновлены следующими командами:

```
artiomn/nb-build-image
artiomn/nb-qt-creator-image
```

[К оглавлению ⮐](#оглавление)


### Как собрать примеры?

Сборка производится, используя CMake, поэтому:

- Вы можете использовать любую современную IDE для сборки.
- Скрипт `./build.sh`.
- Прямой запуск CMake.

Сборка не подгружает зависимости автоматически.
Поэтому, для того, чтобы собрать без необходимости заниматься установкой множества пакетов, используется подготовленная среда.
Она представляет собой Docker-контейнер, образ которого [лежит на docker.hub](https://hub.docker.com/r/artiomn/nb-build-image).
Сборка в ней запускается через скрипт `./build_dockerized.sh`.

Под Windows сборка была проверена на MSVS 2019 и собранные артефакты будут находиться в `src\out\build\windows-default\bin`.
Собираться под Windows будет не всё, есть примеры только под Linux.

[К оглавлению ⮐](#оглавление)


### Сборка не проходит, вообще не собирается ничего

Может быть несколько причин из-за которых не проходит сборка.
Для начала, убедитесь, что у вас:

- Правильно [настроен и работает Docker](#как-использовать-docker).
- Если это первая сборка, есть доступ в Интернет.

Далее, проверьте, что каталог в котором производится сборка, не содержит в пути не латинских символов, пробелов и спецсимволов.

**Не делайте каталог вида**: `~/Общедоступные/user/Пользователь\Артём/*Network Programming BOOK & Code*/本の宿題/Репозиторий?!/network-programming-book-code`.  
Для **большинства сборок** - это верный путь к проблемам, о которых не знали авторы книги и разработчики CMake.

<details>
  <summary>Конкретно в этом каталоге тоже не собирается.</summary>
<pre>
~/Общедоступные/user/Пользователь\Артём/*Network Programming BOOK & Code*/本の宿題/Репозиторий?!/network-programming-book-code:master ✓ ➭ ./build.sh
CMake Error: The source directory "/home/artiom/Общедоступные/user/Пользователь/Артём/*Network Programming BOOK & Code*/本の宿題/Репозиторий?!/network-programming-book-code/src" does not exist.
Specify --help for usage, or press the help button on the CMake GUI.
Error: /home/artiom/Общедоступные/user/Пользователь/Артём/*Network Programming BOOK & Code*/本の宿題/Репозиторий?!/network-programming-book-code/build is not a directory
</pre>

Но сборка в Docker-контейнере будет работать и отсюда.

</details>

Положите репозиторий в каталог с нормальным именем, например `~/projects/cpp-network-tasks`.

Если вы уже собирали проект локально и хотите собрать его в Docker или, наоборот, собирали в Docker и хотите собрать локально, CMake выдаст ошибку, похожую на следующую:

```
CMake Error: The current CMakeCache.txt directory /home/user/projects/cpp-network-tasks/build/CMakeCache.txt is different than the directory /usr/src/gb/build where CMakeCache.txt was created. This may result in binaries being created in the wrong place. If you are not sure, reedit the CMakeCache.txt
CMake Error: The source "/home/artiom/user/cpp-network-tasks/src/CMakeLists.txt" does not match the source "/usr/src/gb/src/CMakeLists.txt" used to generate cache.  Re-run cmake with a different source directory.
```

Что говорит о том, что конфигурации CMake различаются, вы запускаете его в разном окружении.

Чтобы исправить это, **удалите каталог `build`** и запустите сборку заново:

```
➭ rm -rf build && ./build_dockerized.sh
```

[К оглавлению ⮐](#оглавление)


### Почему используется Linux?

- Потому что, на Linux и BSD системах работают большинство сетевых приложений.
- На Linux работает автор курсов.
- Кроме Linux есть множество других ОС, и рассмотреть особенности каждой невозможно.
- Перевод кода на Windows оговорён.
- По возможности, код и так кроссплатформенный.

[К оглавлению ⮐](#оглавление)


### Могу ли я собрать код на Windows?

Да, возможно собрать часть кода. Сборка проверялась на MS Visual Studio 2019.  
Подробнее о поддержке CMake в MSVS, вы можете [прочитать у Microsoft](https://github.com/MicrosoftDocs/cpp-docs/blob/main/docs/build/cmake-projects-in-visual-studio.md).  
Чтобы собрать код, надо открыть корневой CMakeLists.txt, как CMake проект.  

Но есть следующие проблемы:

- Есть код специфичный для Linux, например перехватчик вызовов, который будет собираться и работать только на этой платформе.
- Некоторый код просто не был адаптирован для Windows, и его сборка выключена.
- Есть редкие примеры, которые собираются, но работать корректно не будут (один из таких - асинхронный сервер на `select()`).
  Оно не работает, потому что не было достаточно времени и мотивации, чтобы доработать под Windows.
  Если вы считаете, что можете доделать такой код - You're welcome.
- В Windows есть не все библиотеки, а CMake не имеет, например модуля для поиска Qt, если Qt не установлен.
  Это приводит к тому, что пример не просто нельзя собрать, если чего-то не хватает, а падает сборка.
  Конечно, возможно это исправить, если вы считаете, что нужно, репозиторий открыт для правок.
- Надо установить [Boost](https://sourceforge.net/projects/boost/files/boost-binaries/).

Также, есть некоторый код, специфичный для Windows, но в уроках он, как правило, не упоминается.

[К оглавлению ⮐](#оглавление)


### А есть что-то про CMake?

Есть:

- [CGold: The Hitchhiker’s Guide to the CMake](https://cgold.readthedocs.io/en/latest/).
- [Уроки на Youtube](https://www.youtube.com/watch?v=SM3Klt2rY8g&list=PL6x9Hnsyqn2UwWjSvjCzAY6sEOBrHY7VH).
- [Документация](https://cmake.org/documentation/).
- Много информации в Интернете.

[К оглавлению ⮐](#оглавление)


### Docker - что это?

Предполагается, что в процессе работы с книгой, вы будете использовать поиск в Интернет.  
Соответственно, [Google поможет](https://google.gik-team.com/?q=Docker).  
Если очень кратко, [Docker](https://ru.wikipedia.org/wiki/Docker) - это один из вариантов реализации автоматизации инфраструктуры контейнеризации.  
Он позволяет изолировать приложения в контейнерах, образы которых скачаны из репозитория.
Здесь он нужен для того, чтобы:

- Вы могли собрать код, не устанавливая лишних библиотек.
- Вы могли проверить сборку тем же самым компилятором, что и проверяющий.

Напомню, что образ с инструкциями [лежит на Docker.hub](https://hub.docker.com/r/artiomn/nb-build-image).

[К оглавлению ⮐](#оглавление)


#### Как использовать Docker?

На Windows только [вместе с Linux подсистемой](https://docs.microsoft.com/en-us/windows/wsl/install).  
На Linux его надо установить, а как, зависит от вашего дистрибутива.
Например, в deb-based это делается [по следующей инструкции](https://docs.docker.com/engine/install/debian/).

[К оглавлению ⮐](#оглавление)


#### У меня сборка только под суперпользователем (root) запускается, почему?

Управлять Docker, в том числе и запускать или останавливать контейнеры могут только:

- Пользователь `root`.
- Пользователи в группе `docker`.

Добавить вашего пользователя в группу Docker возможно по-разному. Один из вариантов, который будет работать для многих дистрибутивов:

```
$ sudo usermod -a -G docker "${USER}"
```

После этого надо завершить сессию, например выйти на Login Screen, и снова войти.

[К оглавлению ⮐](#оглавление)


#### Могу ли я собирать в IDE?

Это зависит от IDE. Возможно использовать удалённую сборку по SSH (сервер установлен в образе), некоторые IDE, такие как CLion, поддерживают работу с Docker напрямую.  

[К оглавлению ⮐](#оглавление)


##### CLion

Пример настройки CLion показан [здесь](https://blog.jetbrains.com/clion/2021/10/clion-2021-3-eap-new-docker-toolchain/).

Настройки конфигурации Docker показаны на скриншоте:

![](img/todo/clion_docker_toolchain.png)

Настройки конфигурации CMake:

![](img/todo/clion_docker_cmake.png)

[К оглавлению ⮐](#оглавление)


##### QtCreator

Раньше QtCreator не поддерживал [удалённую сборку по SSH](https://stackoverflow.com/questions/42880004/with-qtcreator-how-can-i-build-my-project-on-a-remote-server-i-have-ssh-access).

Есть вариант настройки [с подмонтированием каталога через SSHFS](https://forum.qt.io/topic/9928/qt-creator-remote-development-via-ssh-for-desktop-projects).
Но все пути к инклудам, а также библиотекам, естественно, будут некорректны, т.к. в контейнере они другие.

Возможно самый просто вариант - установить QtCreator в контейнер и запустить оттуда.
На данный момент для этого [собран образ](https://hub.docker.com/r/artiomn/nb-qt-creator-image).
Чтобы запустить его, используйте:

```
./run -q
```

![QtCreator, запущенный в Docker](img/todo/qt_creator_docker.png)

[К оглавлению ⮐](#оглавление)


#### Не могу подключиться к Docker либо IDE его не видит, что делать?

Проверьте:

- Установлен ли у вас Docker. Если нет - [установите](https://docs.docker.com/engine/install/).
- Достаточно ли прав у вашего пользователя, что с Docker взаимодействовать.

В большинстве дистрибутивов, при установке Docker создаёт группу `docker`, что вы можете проверить, выполнив следующую команду:

```
$ grep docker /etc/group
docker:x:997:
```

Видно, что пользователя в этой группе нет.
Добавьте его туда:

```
$ sudo usermod -a -G docker "$USER"
```

```
$ grep docker /etc/group
docker:x:997:artiom
```

После того, как вы перелогинитесь в системе, группа будет видна:

```
$ groups
sys network power video storage lp input audio wheel artiom docker
```

[К оглавлению ⮐](#оглавление)


#### В образе чего-то не хватает

Возможно, образ устарел.
Обновите его:

```
$ docker pull artiomn/nb-build-image
Using default tag: latest
latest: Pulling from artiomn/nb-build-image
Digest: sha256:be8e76c39543bd03f503a294d96dc578c5ad90b77c1473e6b03ef1feb88c0b0c
Status: Downloaded newer image for artiomn/nb-build-image:latest
docker.io/artiomn/nb-build-image:latest
```

[К оглавлению ⮐](#оглавление)


### Работая в Docker я не могу испортить систему?

Можете. Контейнер запускается в privileged режиме. Т.е. из него возможно создавать устройства, а значит испортить всё, что угодно.
Это требуется для того, чтобы сети, в частности Yggdrasil, могли создать TUN устройство.

[К оглавлению ⮐](#оглавление)


### Как запустить собранное?

Если вы производили сборку, как указано выше, собранные бинарные файлы будут находиться в каталоге `build/bin`.
Запустить вы их можете напрямую, однако из-за отсутствующих в системе зависимостей работать может не всё.
Поэтому, запуск также производится в контейнере, используя команду `./run`, которой передаются необходимые приложению аргументы и путь к нему.

Пример:

```
➭ ./run sudo ./build/bin/ch02-ping google.com
Pinging "google.com" [64.233.165.113]
Start to sending packets...
Sending packet 0 to "google.com" request with id = 29
Receiving packet 0 from "google.com" response with id = 29, time = 15.5ms
```

[К оглавлению ⮐](#оглавление)


### Как запустить консоль?

- `./run`
- `docker-compose run --rm gb` - для тех, кто пользуется docker-compose.

**Обратите внимание:** консоль запускается через **скрипт `./run`** в корне репозитория, **не** через `docker run`.


[К оглавлению ⮐](#оглавление)


### Где взять Netcat под Windows?

Например, [здесь](https://github.com/diegocr/netcat).

**Внимание!**  
Windows Defender может заблокировать Netcat, определив его, как Netcat.Hacktool.
В таком случае, просто отключите "защиту реального времени".

[К оглавлению ⮐](#оглавление)


### Всё делаю правильно, но что-то не подключается

Такая проблема была у одного из студентов. Он выяснил, что Netcat подключался на IPv6 адрес, тогда как сервер прослушивал только IPv4.
Как исправить? Зависит от приложения. Задайте ему не доменное имя, а IPv4 адрес явно, при возможности.
Для Netcat возможно использовать опцию `-4` (не все реализации её поддерживают).

[К оглавлению ⮐](#оглавление)


### Я нашёл ошибку в коде, могу ли я её исправить

Да. Следуя обычному процессу Guthub:

- Сначала делаете форк репозитория.
- Клонируете его, исправляете ошибку.
- Делаете Pull request.

Или просто можете просто завести [Issue](https://github.com/artiomn/cpp-network-tasks/issues/new/choose).
Но, в этом случае, обещать быстрое исправление я не могу.

[К оглавлению ⮐](#оглавление)
